# Name the node stage "builder"
# LOCAVORA WAS
#FROM node:14 AS builder
FROM node:14-slim AS builder

WORKDIR /app

# LOCAVORA copy only package.json and package-lock.json first to leverage Docker cache
COPY package.json package-lock.json ./

# install node modules and build assets
# LOCAVORA - use npm ci so that dependencies are installed exactly as specified in package-lock.json
#            disable audit and fund messages
RUN npm ci --production --no-audit --no-fund
# RUN npm install --no-audit --no-fund

# LOCAVORA copy the rest of the application source code
COPY src ./src
COPY public ./public
COPY tailwind.config.js ./

# LOCAVORA - defines build-time arguments
ARG REACT_APP_BASE_URL
ARG REACT_APP_MMI_BASE_URL
ARG REACT_APP_FIREBASE_API_KEY
ARG REACT_APP_FIREBASE_AUTH_DOMAIN
ARG REACT_APP_GOOGLE_API_KEY
ARG REACT_APP_JUSTPAY_CLIENT_AND_MERCHANT_KEY
ARG REACT_APP_MERCHANT_KEY_ID
ARG REACT_APP_PAYMENT_SDK_ENV
ARG REACT_APP_PAYMENT_SERVICE_URL

# LOCAVORA - uses build-time arguments above to set environment variables when the image is run
# LOCAVORA ATTENTION - these environment variables are embedded into the js build (process.env), so:
#   1. Changing them at runtime will have no effect
#   2. They should not contain sensitive information
ENV REACT_APP_BASE_URL ${REACT_APP_BASE_URL}
ENV REACT_APP_MMI_BASE_URL ${REACT_APP_MMI_BASE_URL}
ENV REACT_APP_FIREBASE_API_KEY ${REACT_APP_FIREBASE_API_KEY}
ENV REACT_APP_FIREBASE_AUTH_DOMAIN ${REACT_APP_FIREBASE_AUTH_DOMAIN}
ENV REACT_APP_GOOGLE_API_KEY ${REACT_APP_GOOGLE_API_KEY}
ENV REACT_APP_JUSTPAY_CLIENT_AND_MERCHANT_KEY ${REACT_APP_JUSTPAY_CLIENT_AND_MERCHANT_KEY}
ENV REACT_APP_MERCHANT_KEY_ID ${REACT_APP_MERCHANT_KEY_ID}
ENV REACT_APP_PAYMENT_SDK_ENV ${REACT_APP_PAYMENT_SDK_ENV}
ENV REACT_APP_PAYMENT_SERVICE_URL ${REACT_APP_PAYMENT_SERVICE_URL}


RUN npm run-script build

# nginx image for serving built content
FROM nginx:alpine

# Set working directory to nginx asset directory
WORKDIR /usr/share/nginx/html

# Remove default nginx static assets
RUN rm -rf ./*
# Copy static assets from builder stage
COPY --from=builder /app/build .
COPY nginx-without-ssl.conf /etc/nginx/conf.d/default.conf

# Containers run nginx with global directives and daemon off
ENTRYPOINT ["nginx", "-g", "daemon off;"]